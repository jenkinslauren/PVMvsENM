---
title: "Fraxinus profunda cleaning"
author: "Lauren Jenkins"
date: "10 December 2021"
output: html_document
---

In the interest of time, load range maps from previous workspace.
111 = full species name all lowercase
222 = abreviated species name (ex. Frax_Dipe)
333 = species name with first letter capital
444 = abreviated species name (ex. FraxDipe)
```{r, include=FALSE}
rm(list = ls())
# setwd('/Users/laurenjenkins/Documents/MOBOT/PVMvsENM/')
load('./01 - Modeling Workspace - Fraxinus Range Maps (BIEN + Little)')
ll <- c('longitude', 'latitude')
species <- "fraxinus profunda"
speciesAb <- "Frax_Prof"
range <- littleRange_FraxProf
title <- expression(paste(italic("Fraxinus profunda"), " occurrences"))
```

Load required packages.
```{r, include = FALSE}
# Load packages
library(enmSdm)

# for handling rasters
library(raster)
# library(rgeos) # not used, but may be helpful when debugging

# visualization tools
library(sp)
library(sf)
library(maps)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)
library(rnaturalearthhires)

# additional tools
library(tools)
library(units)
library(dplyr)

# nad27
default_crs = sf::st_crs(4267)
```

Cleaning *Fraxinus profunda*.
Standard cleaning procedures: 
* remove records without coordinates or dates
* remove records before 1900
* date_collected column is recorded twice, remove one of them

```{r, include = FALSE}
speciesFileName <- paste0('./species_records/01_', 
                              gsub(tolower(species), pattern = ' ', 
                                   replacement = '_'), '_retained_records.rds')

if (file.exists(speciesFileName)) {
  occs <- readRDS(speciesFileName)
} else {
  load(paste0('./species_records/00_', 
              gsub(tolower(species), pattern = ' ', 
                   replacement = '_'), '_bien_all_occurrences.rda'))
  
  # 1,732 occurrences
  
  # remove records without coordinates or dates to ensure locational reliability
  occs <- occsRaw[!(is.na(occsRaw$longitude) | is.na(occsRaw$latitude) | is.na(occsRaw$date_collected)), ]
  
  # remove records before 1900
  occs$Year <- substr(occs$date_collected, 1, 4)
  occs <- occs[occs$Year >= 1900, ]
  # 1,723 occurrences
  
  # date_collected column is there twice, remove one of them
  occs[18] <- NULL
  
  saveRDS(occs, speciesFileName)
}
```

Dealing with imprecise coordinates DMS = FALSE.
```{r}
llOcc <- cbind(occs$longitude, occs$latitude)
coordPrecis <- coordPrecision(llOcc)
precision <- data.frame(llOcc, coordPrecis)

hist(precision$coordPrecis,
     breaks=100,
     xlab='Coordinate uncertainty (m)',
     ylab='Number of records',
     main='',
     col='red'
)
```

Dealing with imprecise coordinates DMS = TRUE.
```{r}
llOcc <- cbind(occs$longitude, occs$latitude)
coordPrecisDMS <- coordPrecision(llOcc, dms = TRUE)
precision <- data.frame(llOcc, coordPrecisDMS)

hist(precision$coordPrecisDMS,
     breaks=100,
     xlab='Coord Precision (m)',
     ylab='Number of records',
     main='',
     col='red'
)
```

Find the max between two precision measurements and remove occurrences where precision > 1,000m.
```{r}
pmaxPrecision <- pmax(coordPrecis, coordPrecisDMS)
occs <- data.frame(occs, pmaxPrecision)
print(paste0("Number of occurrences with precision > 1,000 m = ", 
             length(which(occs$pmaxPrecision > 1000))))
occs <- occs[which(occs$pmaxPrecision <= 1000), ]
```

Create spatial object for plotting.
Map of all observations:

```{r}
# Convert to spatial object for plotting
par(mfrow=c(1,1))
occsSp <- SpatialPointsDataFrame(occs[, ll], data = occs, proj4 = getCRS('nad27', TRUE))
plot(occsSp, pch = 16, cex = 0.3, col = 'red', 
     main = "Little range map, all observations not cleaned")
plot(range, col = alpha('blue', 0.4), border = 'blue', add = TRUE)
map("state", add = TRUE)
map("world", add = TRUE)
```

Thin data.
```{r}
thinnedFileName <- paste0('./species_records/02_', 
                              gsub(tolower(species), pattern = ' ', 
                                   replacement = '_'), '_thinned_records.rData')

if (file.exists(thinnedFileName)) {
  load(thinnedFileName)
} else {
  # memory.limit() - will give you something with memory (how much is remaining or it's capacity)
  # lsos might also help with identifying how much memory
  k <- nrow(occs) / 1000
  # cut_number divides the dataframe into k groups by longitude value
  occs$folds <- as.numeric(cut_number(occs$longitude, k))
  folds <- split(occs, occs$folds)
  
  # sanity check
  print(paste0("Sanity check: does (# of occurrences) ", nrow(occs), 
               " = (# of occurrences in folds) ", sum(sapply(folds, nrow)), "?"))
  
  i <- 1 
  thinnedFolds <- list()
  
  thin <- function(df) {
    p <- paste0("*X", i, ".")
    names(df) <- gsub(pattern = p, replacement = "", x = names(df))
    return(geoThinApprox(df, 1000, c('longitude', 'latitude')))
  }
  
  while(TRUE) {
    currentFold <- thin(data.frame(folds[i]))
    thinnedFolds[[i]] <- currentFold
    i <- i + 1
    if (i > (k + 1)) {
      break
    }
  }
  
  thinned <- as.data.frame(do.call(rbind, thinnedFolds))
  thinned <- geoThinApprox(thinned, 1000, c('longitude', 'latitude'))
  
  finalThinned <- elimCellDups(thinned, raster::raster(), longLat = c('longitude', 'latitude'))
  
  save(thinned, finalThinned, file = thinnedFileName)
}

```

Before eliminating cell duplicates (X observations):
```{r}
thinnedSp <- SpatialPointsDataFrame(thinned[, ll], data = thinned, 
                                         proj4 = getCRS('nad27', TRUE))
plot(thinnedSp, pch = 16, cex = 0.3, col = "red", 
     main = 'BIEN occurrences thinned, before eliminating cell duplicates')
plot(range, col = alpha('blue', 0.4), border = 'blue', add = TRUE)
map("state", add = TRUE)
map("world", add = TRUE)
```

Using sf for spatial visualization (easily customizable):
```{r}
speciesSf <- st_as_sf(x = finalThinned,
                      coords = c(x = 'longitude',
                                 y = 'latitude'),
                      crs = default_crs)
speciesSfThin <- st_as_sf(x = thinned,
                      coords = c(x = 'longitude',
                                 y = 'latitude'),
                      crs = default_crs)
```

```{r}
# load country/world basemap data
world <- ne_countries(scale = "medium", returnclass = "sf")
states <- st_as_sf(ne_states(country = 'united states of america'))
canada <- st_as_sf(ne_states(country = 'canada'))

ggplot(data = world) +
  theme_bw() +
  geom_sf(fill = "white") +
  geom_sf(data = states, fill = NA) + 
  geom_sf(data = canada, fill = NA) + 
  geom_sf(data = speciesSf, col = alpha('red'), cex = 0.5) +
  coord_sf(xlim = c(min(thinned$longitude), max(thinned$longitude)), 
           ylim = c(min(thinned$latitude), max(thinned$latitude)), expand = TRUE) +
  xlab("Longitude") + 
  ylab("Latitude") +
  ggtitle(title, subtitle = "(Cleaned and thinned)") +
    theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
        size = 0.5), panel.background = element_rect(fill = "lavender"))

```

Set buffer.
```{r, include = FALSE}

bufferFileName <- paste0('./cleaning_records/', 
                         gsub(tolower(species), pattern = ' ', 
                              replacement = '_'), '_buffer.rData')

if (file.exists(bufferFileName)) {
  load(bufferFileName)
} else {
  # choose a buffer that will include 97% (0.03 * # of occurrences) of the observations
  # you can change this value based on the threshold you want for your buffer
  threshold <- ceiling(0.03 * nrow(speciesSf))
  
  rangeMap <- st_transform(st_as_sf(x = range), getCRS('albersNA'))
  speciesSfThinAlb <- st_transform(speciesSfThin, getCRS('albersNA'))
  speciesSfAlb <- st_transform(speciesSf, getCRS('albersNA'))
  
  calculate_buffer <- function(x) {
    while (TRUE) {
      x <- x + 10
      buffer_distance <- as_units(x, "km")
      range_buffer <- st_buffer(rangeMap, dist = buffer_distance)
      
      speciesSf_filtered <- speciesSfAlb %>%
        mutate(within_range = lengths(st_within(x = speciesSfAlb,
                                                y = rangeMap)),
               within_buffer = lengths(st_within(x = speciesSfAlb,
                                                 y = range_buffer)))
      
      # These are for a sanity check when first running
      # Uncomment them if you want to see how the # of occurrences outside the buffer
      # decreases as the buffer distance increases
      
      # print(paste0("Buffer distance = ", x, " km"))
      # print(paste0("Number of occurrences outside buffer = ",
      #              length(which(speciesSf_filtered$within_buffer == 0))))
      
      if(length(which(speciesSf_filtered$within_buffer == 0)) < threshold) {
        thinnedSf_filtered <- speciesSfThinAlb %>% 
          mutate(within_range = lengths(st_within(x = speciesSfThinAlb,
                                                  y = rangeMap)),
                 within_buffer = lengths(st_within(x = speciesSfThinAlb,
                                                   y = range_buffer)))
        
        save(buffer_distance, range_buffer, speciesSf_filtered, 
             thinnedSf_filtered, file = bufferFileName)
        break
      }
    }
    
    return(buffer_distance)
  }
  
  x <- 0
  calculate_buffer(x)
}

load(bufferFileName)
```

Thinned, before elimCellDups with calculated buffer.
Points that fall outside a buffer are colored red.
```{r}
ggplot(data = world) +
  theme_bw() +
  geom_sf(fill = "white") +
  geom_sf(data = states, fill = NA) + 
  geom_sf(data = canada, fill = NA) +
  geom_sf(data = rangeMap, 
          color = 'darkgreen',
          fill = 'green', 
          alpha = 0.4, 
          inherit.aes = FALSE) +
  geom_sf(data = range_buffer,
          color = 'yellow',
          fill = NA,
          inherit.aes = FALSE) +
  geom_sf(data = thinnedSf_filtered,
          size = 0.75, 
          aes(color = within_buffer > 0),
          inherit.aes = FALSE) +
  scale_colour_manual(values = setNames(c('black','red'),c(T, F)), guide = "none") +
  guides(fill = "none") +
  coord_sf(xlim = c(min(thinned$longitude) - 5, max(thinned$longitude) + 5), 
           ylim = c(min(thinned$latitude), max(thinned$latitude) + 5), expand = TRUE) +
  xlab("Longitude") + 
  ylab("Latitude") +
  ggtitle(title, 
          subtitle = paste0("(Cleaned, thinned, before cell duplicates eliminated, buffer = ",
                            buffer_distance, 
                            " km)")) +
  theme(panel.grid.major = element_line(color = gray(0.5), 
                                        linetype = "dashed", 
                                        size = 0.5), 
        panel.background = element_rect(fill = "lavender"),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
```

Full range with calculated buffer and cell duplicates eliminated.
```{r}
ggplot(data = world) +
  theme_bw() +
  geom_sf(fill = "white") +
  geom_sf(data = states, fill = NA) + 
  geom_sf(data = canada, fill = NA) +
  geom_sf(data = rangeMap, 
          color = 'darkgreen',
          fill = 'green', 
          alpha = 0.4, 
          inherit.aes = FALSE) +
  geom_sf(data = range_buffer,
          color = 'yellow',
          fill = NA,
          inherit.aes = FALSE) +
  geom_sf(data = speciesSf_filtered,
          size = 0.75,
          aes(color = within_buffer > 0),
          inherit.aes = FALSE) +
  scale_colour_manual(values = setNames(c('black','red'),c(T, F)), guide = "none") +
  guides(fill = "none") +
  coord_sf(xlim = c(min(thinned$longitude) - 5, max(thinned$longitude) + 5), 
           ylim = c(min(thinned$latitude), max(thinned$latitude) + 5), expand = TRUE) +
  xlab("Longitude") +
  ylab("Latitude") +
  ggtitle(title, subtitle = paste0("(Cleaned, thinned, and duplicates eliminated, with buffer = ",
                                   buffer_distance, " km)")) +
  theme(panel.grid.major = element_line(color = gray(0.5), 
                                        linetype = "dashed", 
                                        size = 0.5), 
        panel.background = element_rect(fill = "lavender"), 
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
```

```{r}
speciesSf_filtered_final <- speciesSf %>%
  mutate(within_range = lengths(st_within(x = speciesSfAlb,
                                          y = rangeMap)),
         within_buffer = lengths(st_within(x = speciesSfAlb,
                                          y = range_buffer))) %>%
  filter(within_buffer > 0)

# range_buffer_final <- range_buffer %>% filter(AREA == max(range_buffer$AREA))
range_buffer_final <- st_union(range_buffer)

cleanedRecordsFileName <- paste0('./cleaning_records/', 
                         gsub(tolower(species), pattern = ' ', 
                              replacement = '_'), '_finalRecords.rData')

save(speciesSf_filtered_final, range_buffer_final, file = cleanedRecordsFileName)

ggplot(data = world) +
  theme_bw() +
  geom_sf(fill = "white") +
  geom_sf(data = states, fill = NA) + 
  geom_sf(data = canada, fill = NA) +
  geom_sf(data = rangeMap, 
          color = 'darkgreen',
          fill = 'green', 
          alpha = 0.4, 
          inherit.aes = FALSE) +
  geom_sf(data = range_buffer_final,
          color = 'yellow',
          fill = NA,
          inherit.aes = FALSE) +
  geom_sf(data = speciesSf_filtered_final,
          size = 0.5,
          aes(color = within_range > 0),
          inherit.aes = FALSE) +
  scale_colour_manual(values = setNames(c('black','red'),c(T, F)), guide = "none") +
  guides(fill = "none") +
  coord_sf(xlim = c(min(finalThinned$longitude) - 5, 
                    max(finalThinned$longitude) + 5), 
           ylim = c(min(finalThinned$latitude), 
                    max(finalThinned$latitude) + 5), 
           expand = TRUE) +
  xlab("Longitude") +
  ylab("Latitude") +
  ggtitle(title, subtitle = paste0("(Cleaned, thinned, and duplicates eliminated, with buffer = ",
                                   buffer_distance, " km)")) +
  theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
        size = 0.5), panel.background = element_rect(fill = "lavender"))

```

How many occurrences are in the final dataset?
How many occurrences are outside of the buffer?
```{r}
print(paste0('Final number of occurrences = ', nrow(speciesSf_filtered_final)))
print(paste0("Number of occurrences outside buffer = ", 
             length(which(speciesSf_filtered$within_buffer == 0))))
```

```{r}
imageName <- paste0("./03 - Modeling Workspace - ", speciesAb, " Cleaning")
save.image(imageName)
# load(imageName)
```
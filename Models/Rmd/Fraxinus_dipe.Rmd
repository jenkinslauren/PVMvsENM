---
title: "Fraxinus dipetala model"
author: "Lauren Jenkins"
date: "7 December 2021"
output: html_document
---

Last updated: 14 December 2021

111 = full species name with first letter capital (Fraxinus pennsylvanica)
222 = full species name, all lowercase, _ inbetween (fraxinus_pennsylvanica)
333 = abreviated species name (ex. FraxPenn)
444 = abreviated with _ inbetween 

Setup environment:
```{r, include = FALSE}
rm(list = ls())
library(dplyr)
library(ggplot2)
library(tidyr)

library(raster)
library(rgdal)
library(enmSdm)
library(terra)
library(maxnet)
library(sf)

library(maps)
library(rnaturalearth)
library(rnaturalearthdata)
library(rnaturalearthhires)

setwd('/Volumes/LJ MacBook Backup/MOBOT/PVMvsENM')
load('./PCA_Beyer')
```

Constants:
```{r}
ll <- c('longitude', 'latitude')
sp <- 'Fraxinus dipetala'
species <- 'fraxinus_dipetala'
speciesAb <- 'FraxDipe'
speciesAb_ <- 'Frax_Dipe'
```

Load environmental PCA data. If already clipped, load that, otherwise clip the data to presences.
```{r, include = FALSE}
# if already clipped, load clipped environmental data
fileName <- paste0('./data_and_analyses/env_data/Beyer/envDataClipped.tif')
if (file.exists(fileName)) {
  envData <- brick(fileName)
  names(envData) <- paste0('pca', 1:3)
} else {
  pcPrediction <- list()
  for (i in 1:length(clim)) {
    names(clim[[i]]) <- c("bio1", "bio10", "bio11", "bio12", "bio13", "bio14", 
                          "bio15", "bio16", "bio17", "bio18", "bio19", "bio4", 
                          "bio5", "bio6", "bio7", "bio8", "bio9", 
                          "cloudiness", "relative_humidity")
    pcPrediction[i] <- raster::predict(clim[[i]], 
                                       pca, 
                                       index = 1:3)
    names(pcPrediction[[i]]) <- paste0("pc", 1:3, "_", (i-1)*1000, "KYBP")
  }
  
  envDataPca <- stack(pcPrediction)
  # plot(envDataPca)
  envPresences <- stack(envDataPca[[1:3]])
  names(envPresences) <- paste0('pca', 1:3)
  # the projection of these are wgs84
  
  # define study region & extent.
  if (file.exists('./data_and_analyses/study_region/Study Region.Rdata') & 
      file.exists('./data_and_analyses/study_region/Study Region Extent.Rdata')) {
    load('./data_and_analyses/study_region/Study Region.Rdata')
    load('./data_and_analyses/study_region/Study Region Extent.Rdata')
  } else {
    studyRegion <- rgdal::readOGR(dsn = './data_and_analyses/study_region', 
                                  'study_region')
    studyRegion <- crop(studyRegion, 
                        extent(-178.2166, 83.7759, -55.90223, 83.6236))
    projection(studyRegion) <- getCRS("WGS84")
    studyExtent <- extent(studyRegion)
    save(studyRegion, 
         file='./data_and_analyses/study_region/Study Region.Rdata', 
         compress=TRUE)
    save(studyExtent, 
         file='./data_and_analyses/study_region/Study Region Extent.Rdata', 
         compress=TRUE)
  }
  
  # clip environmental PCA's to study extent & visualize:
  envDataClipped <- list()
  for (i in 1:nlayers(envPresences)) {
    x <- envPresences[[i]]
    x <- crop(x, studyExtent)
    x <- mask(x, studyRegion)
    projection(x) <- getCRS("WGS84")
    envDataClipped[[i]] <- x
    envData <- stack(envDataClipped)
    # plot(envData)
    writeRaster(envData, fileName, format = 'GTiff', overwrite = T)
  }
}
```

Load records for given species.
```{r}
records <- paste0('./cleaning_records/', species, '_finalRecords.rData')
load(records)
records <- data.frame(speciesSf_filtered_final) # 542 observations
records$geometry <- gsub("[c()]", "", records$geometry)
records <- separate(data = records, 
                    col = 'geometry', 
                    into = c("longitude", "latitude"), 
                    sep = "\\,")
records$longitude <- as.double(records$longitude)
records$latitude <- as.double(records$latitude)
```

Match environmental data to records.
```{r}
envSpecies <- raster::extract(envData, 
                              cbind(records$longitude, 
                                    records$latitude))
envSpecies <- as.data.frame(envSpecies)
records <- cbind(records, envSpecies)
```

Remove records that fall in the water & visualize.
```{r}
# records in the water:
if (any(is.na(rowSums(envSpecies)))) {
  water <- records[which(is.na(rowSums(envSpecies))), ] 
  water <- SpatialPointsDataFrame(water[,ll], data = water,
                                proj4 = getCRS('wgs84', TRUE))
}

# remove records in water from dataset:
if (any(is.na(rowSums(envSpecies)))) records <-
  records[-which(is.na(rowSums(envSpecies))), ]

# visualize the points that fall in the water
# convert to sp object
recordsSp <- SpatialPointsDataFrame(records[, ll], data = records,
                                       proj4 = getCRS('wgs84', TRUE))

# visualize
plot(recordsSp, pch = 16, cex = 0.5, col = "red", 
     main = substitute(paste(italic('Fraxinus dipetala '), 'occurrences (BIEN) thinned')))
if (exists("water")) {
  plot(water, col = 'blue', add = TRUE)
}
map("state", add = TRUE)
map("world", add = TRUE)
```

Save workspace.
```{r}
save.image(paste0('./04 - Modeling Workspace - Clipping ', sp))
# load(paste0('./04 - Modeling Workspace - Clipping ', sp))
```

```{r}
climate <- envData
# generate 10,000 background sites
randomBgSites <- randomPoints(climate, 10000)

# extract environment at sites
randomBgEnv <- raster::extract(climate, randomBgSites)
randomBgEnv <- as.data.frame(randomBgEnv)

# remove any sites with NA for at least one variable
isNa <- is.na(rowSums(randomBgEnv))
if (any(isNa)) {
    randomBgSites <- randomBgSites[-which(isNa), ]
    randomBgEnv <- randomBgEnv[-which(isNa), ]
}

# combine with coordinates and rename coordinate fields
randomBg <- cbind(randomBgSites, randomBgEnv)
names(randomBg)[1:2] <- c('longitude', 'latitude')
dir.create('./Background Sites', recursive=TRUE, showWarnings=FALSE)
save(randomBg, file=
    './Background Sites/Random Background Sites across Study Region.Rdata',
    compress=TRUE)
```

Load cleaned data.
```{r}
load(paste0('./03 - Modeling Workspace - ', speciesAb_, ' Cleaning'))
rangeMap <- littleRange_FraxDipe
```

Ready for maxent!
Turn off clamping to avoid extrapolating (in maxnet(), clamp = FALSE)
Also, type = cclog (to make the output between 0 & 1)
```{r}
calibRegionSpAlb <- as(range_buffer_final, 'Spatial')
projection(calibRegionSpAlb) <- getCRS("albersNA")

# get random background sites
bgTestSpAlb <- spsample(calibRegionSpAlb, n=10000, type='random')
bgTestSp <- sp::spTransform(bgTestSpAlb, getCRS('wgs84', TRUE))
bgTest <- as.data.frame(coordinates(bgTestSp))
names(bgTest) <- ll

# extract environment at sites
# randomBgSites <- randomPoints(climate, 10000)
randomBgEnv <- raster::extract(climate, bgTest)
randomBgEnv <- as.data.frame(randomBgEnv)

# remove any sites with NA for at least one variable
isNa <- is.na(rowSums(randomBgEnv))
if (any(isNa)) {
    randomBgSites <- bgTest[-which(isNa), ]
    randomBgEnv <- randomBgEnv[-which(isNa), ]
}

# combine with coordinates and rename coordinate fields
randomBg <- cbind(randomBgSites, randomBgEnv)
names(randomBg)[1:2] <- ll

presBg <- rep(c(1, 0), c(nrow(records), nrow(randomBgSites)))

occsEnv <- raster::extract(envData, 
                              cbind(records$longitude, 
                                    records$latitude))

env <- rbind(occsEnv, randomBgEnv)
env <- cbind(presBg, env)
env <- as.data.frame(env)

# create output directory for model object and rasters
dir.create(paste0('./Models/', speciesAb_, '_Maxent'),
    recursive=TRUE, showWarnings=FALSE)

# model species
envModel <- enmSdm::trainMaxNet(data = env, resp = "presBg")
# envModel <- maxnet(p = presBg, data = trainData)
modelFileName <- paste0('./Models/', speciesAb_, '_Maxent/Model.Rdata')
save(envModel, file = modelFileName, compress=TRUE)

# prediction
envMap <- predict(
  climate[[predictors]],
  envModel,
  filename=paste0('./Models/', speciesAb_, '_Maxent/maxentPredictionBeyer0KYBP'), 
  clamp = F, 
  format='GTiff', 
  overwrite = TRUE, 
  type='cloglog')
```

Try visualizing using sf (having trouble with this, so haven't implemented yet).
```{r}
envMapSp <- rasterToPolygons(envMap)

# envMapSf <- st_as_sf(envMapSp,
#                      coords = c(x = 'longitude', y = 'latitude'),
#                       crs = getCRS("wgs84", TRUE))
# rangeMapSf <- st_transform(st_as_sf(x = range), getCRS('wgs84', TRUE))
# recordsSf <- speciesSf <- st_as_sf(x = records,
#                       coords = c(x = 'longitude',
#                                  y = 'latitude'),
#                       crs = getCRS('wgs84', TRUE))
# 
# world <- ne_countries(scale = "medium", returnclass = "sf")
# states <- st_as_sf(ne_states(country = 'united states of america'))
# canada <- st_as_sf(ne_states(country = 'canada'))

# ggplot(data = world) +
#   theme_bw() +
#   geom_sf(fill = "white") +
#   geom_sf(data = states, fill = NA) + 
#   geom_sf(data = canada, fill = NA) +
#   geom_sf(data = envMapSf) +
#   geom_sf(data = rangeMapSf, 
#           color = 'darkgreen',
#           fill = 'green', 
#           alpha = 0.4, 
#           inherit.aes = FALSE) +
#   geom_sf(data = recordsSf,
#           color = 'red',
#           pch = 16,
#           cex = 0.4) + 
#   coord_sf(xlim = c(min(records$longitude), max(records$longitude)), 
#            ylim = c(min(records$latitude), max(records$latitude)), expand = TRUE) +
#   xlab("Longitude") + 
#   ylab("Latitude") +
#   theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
#                                         size = 0.5), panel.background = element_rect(fill = "lavender"))

```

```{r}
plot(rangeMap, border = 'blue', main = substitute(paste('Maxent output, ', 
                                                        italic('Fraxinus dipetala '),
                                                        'occurrences')))
plot(envMap, add = TRUE)
plot(rangeMap, border = 'blue', add = TRUE)
map("state", add = TRUE)
map("world", add = TRUE)
points(records$longitude, records$latitude, pch = 16, cex = 0.6, col = 'red')
```

```{r}
save.image(paste0('./05 - Modeling Workspace - ', speciesAb_, ' Model Output'))
# load(paste0('./05 - Modeling Workspace - ', speciesAb_, ' Model Output'))
```


<!-- May want to make a MESS map (Elith et al 2010) to show places projected to the past -->
<!-- In the dismo package -->

---
title: "Fraxinus americana model"
author: "Lauren Jenkins"
date: "16 December 2021"
output: html_document
---

Last updated: 20 January 2022

111 = full species name with first letter capital (Fraxinus pennsylvanica)
222 = full species name, all lowercase, _ inbetween (fraxinus_pennsylvanica)
333 = abreviated species name (ex. FraxPenn)
444 = abreviated with _ inbetween 

Setup environment:
```{r, include = FALSE}
rm(list = ls())
library(dplyr)
library(ggplot2)
library(tidyr)

library(raster)
library(rgdal)
library(enmSdm)
library(terra)
library(maxnet)
library(sf)

library(maps)
library(rnaturalearth)
library(rnaturalearthdata)
library(rnaturalearthhires)

knitr::opts_knit$set(root.dir = '/Volumes/lj_mac_22/MOBOT/PVMvsENM')
setwd('/Volumes/lj_mac_22/MOBOT/PVMvsENM')
```

Load PCA environment and set constants:
```{r}
# set constants
pc <- 5
climYear <- 0

# load PCA environment
load(paste0('./PCA_Beyer_PC', pc))

# set constants
ll <- c('longitude', 'latitude')
sp <- 'Fraxinus americana'
species <- 'fraxinus_americana'
speciesAb <- 'FraxAmer'
speciesAb_ <- 'Frax_Amer'
```

Load environmental PCA rasters. If already clipped, load that. Otherwise, clip the data to present.
```{r, include = FALSE}
# Load environmental PCA rasters. 
# If already clipped, load that. 
# Otherwise, clip the data to present.
studyRegionFileName <- '/Volumes/GoogleDrive/.shortcut-targets-by-id/0ByjNJEf91IW5SUlEOUJFVGN0Y28/NSF_ABI_2018_2021/data_and_analyses/green_ash/study_region/!study_region_raster_masks/study_region_daltonIceMask_lakesMasked_linearIceSheetInterpolation.tif'
studyRegionRasts <- brick(studyRegionFileName)

fileName <<- paste0('./data_and_analyses/env_data/Beyer/envDataClipped_',
                    climYear, 'KYBP_pc', pc, '.tif')
if (file.exists(fileName)) {
  envData <- brick(fileName)
  # rename raster layers to pc's
  names(envData) <- paste0('pca', 1:pc)
} else {
  pcPrediction <<- list()
  # label each env layer by variable and year
  pcPrediction <- list()
  for (i in 1:length(clim)) {
    names(clim[[i]]) <- c("BIO1", paste0('BIO', 4:19), "cloudiness", "relative_humidity")
    pcPrediction[i] <- raster::predict(clim[[i]], pca, index = 1:pc)
    names(pcPrediction[[i]]) <- paste0("pc", 1:pc, "_", (i-1)*1000, "KYBP")
  }
  
  envDataPca <- stack(pcPrediction)
  
  # keep only rasters (first five rasters) for climate year
  
  envYr <- pcPrediction[[(climYear/1000) + 1]]
  # plot(envYr) 
  names(envYr) <- paste0('pca', 1:pc)
  
  # check projections = wgs84
  print("Ensure that the projection of these rasters is WGS84:")
  print(paste0("Projection of envYr = ", projection(envYr)))
  
  # define study region & extent, load if already defined
  if (file.exists('./data_and_analyses/study_region/Study Region.Rdata') & 
      file.exists('./data_and_analyses/study_region/Study Region Extent.Rdata')) {
    load('./data_and_analyses/study_region/Study Region.Rdata')
    load('./data_and_analyses/study_region/Study Region Extent.Rdata')
  } else {
    studyRegion <- rgdal::readOGR('/Volumes/lj_mac_22/MOBOT/PVMvsENM/data_and_analyses/study_region',
                                  'study_region')
    studyRegion <- crop(studyRegion, extent(-178.2166, 83.7759, -55.90223, 83.6236))
    projection(studyRegion) <- getCRS("WGS84")
    studyExtent <- extent(studyRegion)
    save(studyRegion, 
         file='/Volumes/lj_mac_22/MOBOT/PVMvsENM/data_and_analyses/study_region/Study Region.Rdata',
         compress=TRUE)
    save(studyExtent, 
         file='/Volumes/lj_mac_22/MOBOT/PVMvsENM/data_and_analyses/study_region/Study Region Extent.Rdata', compress=TRUE)
  }
  
  # clip environmental PCAs to study extent for given species, visualize, and save:
  envDataClipped <- list()
  for (i in 1:nlayers(envYr)) {
    x <- envYr[[i]]
    x <- crop(x, studyExtent)
    # x <<- mask(x, studyRegion)
    projection(x) <- getCRS("WGS84")
    envDataClipped[[i]] <- x
    envData <- stack(envDataClipped)
    # plot(envData)
    writeRaster(envData, fileName, format = 'GTiff', overwrite = T)
  }
} 
```

Load records for given species.
```{r}
recordsRaw <- paste0('./cleaning_records/', species, '_finalRecords.rData')
load(recordsRaw)
recordsRaw <- data.frame(speciesSf_filtered_final) # 542 observations
recordsRaw$geometry <- gsub("[c()]", "", recordsRaw$geometry)
recordsRaw <- separate(data = recordsRaw, 
                    col = 'geometry', 
                    into = ll, 
                    sep = "\\,")
recordsRaw$longitude <- as.double(recordsRaw$longitude)
recordsRaw$latitude <- as.double(recordsRaw$latitude)
```

Match environmental data to records.
```{r}
occsEnv <- raster::extract(envData, 
                              cbind(recordsRaw$longitude, 
                                    recordsRaw$latitude))
occsEnvDf <- as.data.frame(occsEnv)
records <- cbind(recordsRaw, occsEnvDf)
```

Remove records that fall in the water & visualize.
```{r}
# records in the water:
if (any(is.na(rowSums(occsEnvDf)))) {
  water <- records[which(is.na(rowSums(occsEnvDf))), ] 
  water <- SpatialPointsDataFrame(water[,ll], data = water,
                                proj4 = getCRS('wgs84', TRUE))
}

# remove records in water from dataset:
if (any(is.na(rowSums(occsEnvDf)))) records <-
  records[-which(is.na(rowSums(occsEnvDf))), ]

# visualize the points that fall in the water
# convert to sp object
recordsSp <- SpatialPointsDataFrame(records[, ll], data = records,
                                       proj4 = getCRS('wgs84', TRUE))

# visualize
plot(recordsSp, pch = 16, cex = 0.5, col = "red", 
     main = substitute(paste(italic('Fraxinus americana '), 'occurrences (BIEN) thinned')))
if (exists("water")) {
  plot(water, col = 'blue', add = TRUE)
}
map("state", add = TRUE)
map("world", add = TRUE)
```

Save workspace.
```{r}
save.image(paste0('./workspaces/04 - Modeling Workspace - Clipping ', sp))
# load(paste0('./04 - Modeling Workspace - Clipping ', sp))
```

Load cleaned records data.
```{r}
load(paste0('./workspaces/03 - Modeling Workspace - ', speciesAb_, ' Cleaning'))
rangeMap <- littleRange_FraxAmer
```

```{r, warning = FALSE}
# use the buffer/calibration region for extracting background sites
calibRegionSpAlb <- as(range_buffer_final, 'Spatial')
calibRegionSpAlb <- sp::spTransform(calibRegionSpAlb, getCRS('albersNA', TRUE))
calibRegionSpWgs <- sp::spTransform(calibRegionSpAlb, getCRS('wgs84', TRUE))

# get 10,000 random background sites from calibration region
bgTestSpAlb <- spsample(calibRegionSpAlb, n=10000, type='random')
bgTestSp <- sp::spTransform(bgTestSpAlb, getCRS('wgs84', TRUE))
randomBgSites <- as.data.frame(coordinates(bgTestSp))
names(randomBgSites) <- ll


# sanity check: plot the background sites
plot(bgTestSp, pch = 16, cex = 0.5, col = "red", 
     main = substitute(paste(italic('Fraxinus americana '), 'background sites')))
plot(calibRegionSpWgs, add = TRUE, border = 'blue')
map("state", add = TRUE)
map("world", add = TRUE)
```

```{r}
# extract environment at background sites
climate <- envData
randomBgEnv <- raster::extract(climate, randomBgSites)
randomBgEnv <- as.data.frame(randomBgEnv)

# remove any sites with NA for at least one variable
isNa <- is.na(rowSums(randomBgEnv))
if (any(isNa)) {
    randomBgSites <- randomBgSites[-which(isNa), ]
    randomBgEnv <- randomBgEnv[-which(isNa), ]
}

# combine with coordinates and rename coordinate fields
randomBg <- cbind(randomBgSites, randomBgEnv)
names(randomBg)[1:2] <- ll

dir.create('./Background Sites', recursive=TRUE, showWarnings=FALSE)
save(randomBg, 
     file = paste0('./Background Sites/Random Background Sites across Study Region - ', 
                   speciesAb, '.Rdata'),
    compress=TRUE)
```

Ready for maxent!
Turn off clamping to avoid extrapolating (in maxnet(), clamp = FALSE).
Also, type = cloglog (to make the output between 0 & 1).
```{r}
presBg <- rep(c(1, 0), c(nrow(recordsRaw), nrow(randomBg)))

env <- rbind(occsEnv, randomBgEnv)
env <- cbind(presBg, env)
env <- as.data.frame(env)
env <- env[complete.cases(env), ]

# create output directory for model object and rasters
dir.create(paste0('./Models/', speciesAb_, '_Maxent'),
    recursive=TRUE, showWarnings=FALSE)

# model species
envModel <- enmSdm::trainMaxNet(data = env, resp = "presBg")
# envModel <- maxnet(p = presBg, data = trainData)
modelFileName <- paste0('./Models/', speciesAb_, '_Maxent/Model.Rdata')
save(envModel, file = modelFileName, compress=TRUE)

predictors <- c(paste0('pca', 1:pc))
# prediction
envMap <- predict(
  climate[[predictors]],
  envModel,
  filename=paste0('./Models/', speciesAb_, '_Maxent/maxentPredictionBeyer0KYBP_PC', pc), 
  clamp = F, 
  format='GTiff', 
  overwrite = TRUE, 
  type='cloglog')
```

Try visualizing using sf (having trouble with this, so haven't implemented yet).
```{r}
envMapSp <- rasterToPolygons(envMap)
# envMapSf <- st_as_sf(envMapSp,
#                      coords = c(x = 'longitude', y = 'latitude'),
#                       crs = getCRS("wgs84", TRUE))
# rangeMapSf <- st_transform(st_as_sf(x = range), getCRS('wgs84', TRUE))
# recordsSf <- speciesSf <- st_as_sf(x = records,
#                       coords = c(x = 'longitude',
#                                  y = 'latitude'),
#                       crs = getCRS('wgs84', TRUE))
# 
# world <- ne_countries(scale = "medium", returnclass = "sf")
# states <- st_as_sf(ne_states(country = 'united states of america'))
# canada <- st_as_sf(ne_states(country = 'canada'))

# sf object doesn't really work
# ggplot(data = world) +
#   theme_bw() +
#   geom_sf(fill = "white") +
#   geom_sf(data = states, fill = NA) + 
#   geom_sf(data = canada, fill = NA) +
#   geom_sf(data = envMapSf) +
#   geom_sf(data = rangeMapSf, 
#           color = 'darkgreen',
#           fill = 'green', 
#           alpha = 0.4, 
#           inherit.aes = FALSE) +
#   geom_sf(data = recordsSf,
#           color = 'red',
#           pch = 16,
#           cex = 0.4) + 
#   coord_sf(xlim = c(min(records$longitude), max(records$longitude)), 
#            ylim = c(min(records$latitude), max(records$latitude)), expand = TRUE) +
#   xlab("Longitude") + 
#   ylab("Latitude") +
#   theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
#                                         size = 0.5), panel.background = element_rect(fill = "lavender"))

```

Visualize model output, focused on species.
```{r}
plot(rangeMap, border = 'blue', main = substitute(paste('Maxent output, ', 
                                                        italic('Fraxinus americana '),
                                                        'occurrences')))
plot(envMap, add = TRUE)
plot(rangeMap, border = 'blue', add = TRUE)
map("state", add = TRUE)
map("world", add = TRUE)
points(records$longitude, records$latitude, pch = 16, cex = 0.6, col = 'red')
```

Visualize output, zoomed out to study region.
```{r}
plot(envMap, main = substitute(paste('Maxent output, ', 
                                                        italic('Fraxinus americana '),
                                                        'occurrences')))
plot(rangeMap, border = 'blue', add = TRUE)
# map("state", add = TRUE)
# map("world", add = TRUE)
# points(records$longitude, records$latitude, pch = 16, cex = 0.6, col = 'red')
```

Save workspace image.
```{r}
save.image(paste0('./workspaces/05 - Modeling Workspace - ', speciesAb_, ' Model Output - PC', pc))
# load(paste0('./workspaces/05 - Modeling Workspace - ', speciesAb_, ' Model Output'))
```


<!-- May want to make a MESS map (Elith et al 2010) to show places projected to the past -->
<!-- In the dismo package -->
